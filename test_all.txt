============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\SEM 6\shitt\cursor\pharmguard-ai
plugins: anyio-4.11.0, langsmith-0.6.4
collected 19 items

tests\test_end_to_end.py ......                                          [ 31%]
tests\test_nlu.py ...F...                                                [ 68%]
tests\test_persistence.py F                                              [ 73%]
tests\test_safety_engine.py .....                                        [100%]

================================== FAILURES ===================================
______________________________ test_nlu_aspirin _______________________________

    def test_nlu_aspirin():
        """User asks for Aspirin - should match med_aspirin_75."""
        master = load_medicine_master()
        result = run_nlu("I need two Aspirin 75 mg tablets", medicine_master=master)
>       assert result["quantity"] == 2
E       assert 75 == 2

tests\test_nlu.py:35: AssertionError
___________________________ test_stock_persistence ____________________________

    def test_stock_persistence():
        """
        1. Load master (stock from CSV).
        2. Update stock (decrement).
        3. Verify DB matches.
        4. Reload master (simulate restart).
        5. Verify stock is still lower (from DB), not reset to CSV value.
        """
        # 1. Initial load
        reload_master()
        med_id = "med_aspirin_75"
        initial = get_medicine(med_id)
        assert initial is not None
        start_stock = initial["stock"]
    
        # 2. Update stock (simulate order of 5 units)
        update_stock(med_id, -5)
        updated = get_medicine(med_id)
        assert updated["stock"] == start_stock - 5
    
        # 3. Verify DB has snapshot
        db = SessionLocal()
        snap = db.query(InventorySnapshot).filter_by(medicine_id=med_id).first()
>       assert snap is not None
E       assert None is not None

tests\test_persistence.py:46: AssertionError
============================== warnings summary ===============================
backend\app\schema.py:36
  D:\SEM 6\shitt\cursor\pharmguard-ai\backend\app\schema.py:36: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderResponse(BaseModel):

C:\Users\RAHIL\AppData\Local\Programs\Python\Python314\Lib\site-packages\confection\__init__.py:38
  C:\Users\RAHIL\AppData\Local\Programs\Python\Python314\Lib\site-packages\confection\__init__.py:38: UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
    from pydantic.v1 import BaseModel, Extra, ValidationError, create_model

tests/test_end_to_end.py: 10 warnings
tests/test_safety_engine.py: 2 warnings
  C:\Users\RAHIL\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

tests/test_end_to_end.py::test_converse_auto_approve
tests/test_end_to_end.py::test_converse_require_prescription
tests/test_end_to_end.py::test_trace_get
  D:\SEM 6\shitt\cursor\pharmguard-ai\backend\app\services\observability.py:46: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    trace_obj["timestamp"] = datetime.utcnow().isoformat()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_nlu.py::test_nlu_aspirin - assert 75 == 2
FAILED tests/test_persistence.py::test_stock_persistence - assert None is not...
================= 2 failed, 17 passed, 17 warnings in 10.38s ==================
